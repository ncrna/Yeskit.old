
---
title: "Decoding Intracellular Pathogen of H3N2 at the Single-Cell level using Yeskit"
author: "Wei Zhang"
date: "2021/09/10"
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
  html_document:
    toc: yes
    toc_depth: 4
    toc_float: no
    theme: cerulean
    highlight: tango
    number_sections: yes
    df_print: tibble
vignette: >
  %\VignetteIndexEntry{Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[UTF-8]{inputenc}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, eval = TRUE,
                      warnings = FALSE, message = FALSE,
                      fig.width = 6, fig.height = 5)
```

Taking the in-vitro experiment of H3N2 infection data (SRA Accession number: [SRP239555](https://www.ncbi.nlm.nih.gov/sra/?term=SRP239555)) as an example, we used [PathogenTrack](https://github.com/ncrna/PathogenTrack) to identify H3N2 infected cells at the single-cell level and used [Yeskit](https://github.com/ncrna/Yeskit) to analyze and explore the biological functions that may be related to H3N2 infection.

# Install Yeskit from GitHub
```{r installation, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if (!requireNamespace("devtools", quietly = TRUE))
    BiocManager::install("devtools")
#if (requireNamespace("Yeskit", quietly = TRUE))
#    devtools::install_github("ncrna/Yeskit")
```

# Import Yeskit
First, we load the package:
```{r setup, warning=FALSE, message=FALSE}
library(Yeskit)
library(topGO)
```

# Importation
Now, let's load the single-cell count matrix:
```{r import, fig.width=4, fig.height=4}
Bystander <- scRead(sample_name = "Bystander", 
                    data_dir = system.file("extdata/H3N2_10X_matrix/Bystander/", 
                                           package="Yeskit"), 
                    gene_column = 2, project_name = "H3N2", group_name = "Bystander", 
                    meta_file = system.file("extdata/H3N2_10X_matrix/Bystander/microbes.tsv", 
                                            package="Yeskit")
                    )
Infected <- scRead(sample_name = "Infected", 
                   data_dir = system.file("extdata/H3N2_10X_matrix/Infected/", 
                                          package="Yeskit"), 
                   gene_column = 2, project_name = "H3N2", group_name = "Infected", 
                   meta_file = system.file("extdata/H3N2_10X_matrix/Infected/microbes.tsv", 
                                           package="Yeskit"))
```

# Integration
Then, we integrate these two `Seurat` object
```{r integration, message=FALSE, warning=FALSE}
H3N2_integrated <- scIntegrate(object.list=list(Bystander, Infected), 
                               object.names = c("Bystander", "Infected"), 
                               batch.rm = "harmony", res = 0.7)
```

# FindMarkers
```{r cellmarkers, message=FALSE, warning=FALSE}
slot(H3N2_integrated, "misc")$Markers <- Seurat::FindAllMarkers(object = H3N2_integrated,
                                                                assay = 'RNA', 
                                                                test.use = 'MAST')
```

# Differential analysis
## Differential analysis between Infected and Bystander
```{r dge_of_infected_vs_bystander, message=FALSE, warning=FALSE}
slot(H3N2_integrated, "misc")$Infected_vs_Bystander <- scDGE(object = H3N2_integrated, 
                                                             comparison = c("Infected", "Bystander"), 
                                                             group.by = "group", min.cells = 10, 
                                                             logFC = 0.25, clusters = NULL)
```

## Differential analysis between H3N2_positive and H3N2_negative 
```{r dge_of_H3N2pos_vs_H3N2neg, message=FALSE, warning=FALSE}
slot(H3N2_integrated, "misc")$H3N2 <- scPathogenDGE(object = H3N2_integrated, 
                                                    species.by = "H3N2", min.cells = 5)
```

# GO annotation
## GO annotation of Markers
```{r go_of_cellmarkers, message=FALSE, warning=FALSE}
slot(H3N2_integrated, "misc")$Markers.GO <- scGO(object = H3N2_integrated, 
                                                 key = "Markers", 
                                                 logFC = 0.25, 
                                                 only.pos = TRUE, 
                                                 reference = "human")
```

## GO annotation of DGEs between Infected and Bystander
```{r go_of_infected_vs_bystander, message=FALSE, warning=FALSE}
slot(H3N2_integrated, "misc")$Infected_vs_Bystander.GO <- scGO(object = H3N2_integrated, 
                                                               key = "Infected_vs_Bystander", 
                                                               logFC = 0.25, only.pos = FALSE,
                                                               reference = "human")
```

## GO annotation of DGEs between H3N2_positive and H3N2_negative 
```{r go_of_H3N2pos_vs_H3N2neg, message=FALSE, warning=FALSE}
slot(H3N2_integrated, "misc")$H3N2.GO <- scPathogenGO(object = H3N2_integrated, key = "H3N2", 
                                                      clusters = NULL, species = "H3N2", 
                                                      logFC = 0.25)
```

# MSigDB scoring
```{r msigdb_score, message=FALSE, warning=FALSE}
H3N2_integrated <- scMsigdbScoring(object = H3N2_integrated, category = "H", geneSets = NULL)
```

# Visualization
## Visualization of cell clusters by scDimPlot
```{r, fig.height=3, fig.width=8, fig.align="center", fig.cap="Cell DimPlot"}
scDimPlot(object = H3N2_integrated, 
          reduction = "umap", 
          cols = NULL, 
          split.by = "sample", 
          ncol = 2, 
          pt.size = 2)
```

## Visualization of cell densities by scDensityPlot
```{r, fig.height=3, fig.width=8, fig.align="center", fig.cap="Cell Density Plot"}
scDensityPlot(object = H3N2_integrated, 
              reduction = "umap", 
              split.by = "sample", 
              ncol = 2)
```

## Visualization of cell population fractions by scPopulationPlot, the x axis stands for clusters
```{r, fig.height=1, fig.width=1.5, fig.align="center", fig.cap="Cell Population Plot by cluster"}
scPopulationPlot(object = H3N2_integrated, 
                 by = "cluster", 
                 cols = "sc", 
                 order = c("Bystander", "Infected"))
```

## Visualization of cell population fractions by scPopulationPlot, the x axis stands for samples
```{r, fig.height=1, fig.width=1.5, fig.align="center", fig.cap="Cell Population Plot by sample"}
scPopulationPlot(object = H3N2_integrated, 
                 by = "sample", 
                 order = c("Bystander", "Infected"))
```

## Visualization of meta data by scVizMeta
```{r, fig.height=2, fig.width=5, fig.align="center", fig.cap="H3N2 DimPlot"}
scVizMeta(object = H3N2_integrated, 
          reduction = "umap", 
          signature="H3N2", 
          title = "H3N2", 
          raster = TRUE, 
          split.by = "sample", 
          pt.size = 2, 
          interval = c(
            Abundant = 1000, 
            Large = 500, 
            Medium = 100, 
            Small = 10, 
            Single = 1, 
            None = 0)
          )
```

## Visualization of H3N2-infected cell fractions by scPathogenRatioPlot
```{r fig.height=1.5, fig.width=2.5, fig.align="center", fig.cap="H3N2 Ratio Plot"}
scPathogenRatioPlot(object = H3N2_integrated, 
                    species = "H3N2", 
                    split.by = "sample", 
                    ncol = 2)
```

## Visualization of DGEs by scVolcanoPlot
```{r, fig.height=2, fig.width=2, fig.align="center", fig.cap="Volcano Plot of Infected_vs_Bystander"}
scVolcanoPlot(H3N2_integrated, 
              key = "Infected_vs_Bystander", 
              cluster = "0", 
              top_n = 10)
```

## Visualization of enriched GO terms for up-regulated genes by scGOBarPlot
```{r, fig.height=1.5, fig.width=3, fig.align="center", fig.cap="Infected_vs_Bystander.GO_up"}
scGOBarPlot(object = H3N2_integrated, 
            key = "Infected_vs_Bystander.GO", 
            ont = "BP", 
            top_n = 6, 
            direction = "up", 
            cluster = "0")
```

## Visualization of enriched GO terms for down-regulated genes by scGOBarPlot
```{r, fig.height=1.5, fig.width=3, fig.align="center", fig.cap="Infected_vs_Bystander.GO_down"}
scGOBarPlot(object = H3N2_integrated, 
            key = "Infected_vs_Bystander.GO", 
            ont = "BP", 
            top_n = 6, 
            direction = "down", 
            cluster = "0")
```

## Visualization of enriched GO terms for up-regulated genes by scGODotPlot
```{r, fig.height=2, fig.width=3, fig.align="center", fig.cap="Infected_vs_Bystander.GO_up"}
scGODotPlot(object = H3N2_integrated, 
            key = "Infected_vs_Bystander.GO", 
            ont = "BP", 
            direction = "up", 
            top_n = 10, 
            font.size = 8)
```

## Visualization of enriched GO terms for down-regulated genes by scGODotPlot
```{r, fig.height=2, fig.width=2.9, fig.align="center", fig.cap="Infected_vs_Bystander.GO_down"}
scGODotPlot(object = H3N2_integrated, 
            key = "Infected_vs_Bystander.GO", 
            ont = "BP", 
            direction = "down", 
            top_n = 10,
            clusters = c("0"),
            font.size = 8)
```

## Visualization of HALLMARK_INFLAMMATORY_RESPONSE pathway
```{r, fig.height=2, fig.width=5, fig.align="center", fig.cap = "HALLMARK_INFLAMMATORY_RESPONSE"}
scScoreDimPlot(H3N2_integrated, 
               signature = "HALLMARK_INFLAMMATORY_RESPONSE", 
               split.by="sample", 
               ncol = 2, 
               pt.size = 2)
```

## Visualization of HALLMARK_TNFA_SIGNALING_VIA_NFKB pathway
```{r, fig.height=2, fig.width=5, fig.align="center", fig.cap = "HALLMARK_TNFA_SIGNALING_VIA_NFKB"}
scScoreDimPlot(H3N2_integrated, 
               signature = "HALLMARK_TNFA_SIGNALING_VIA_NFKB", 
               split.by="sample", 
               ncol = 2, 
               pt.size = 2)
```

## Visualization of HALLMARK_APOPTOSIS pathway
```{r, fig.height=2, fig.width=5, fig.align="center", fig.cap = "HALLMARK_APOPTOSIS"}
scScoreDimPlot(H3N2_integrated, 
               signature = "HALLMARK_APOPTOSIS", 
               split.by="sample", 
               ncol = 2, 
               pt.size = 2)
```

# Session Information
```{r, echo=FALSE}
sessionInfo()
```

